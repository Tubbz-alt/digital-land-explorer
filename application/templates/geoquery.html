{% extends "base.html" %}
{% block title %}Test geo queries{% endblock %}

{% block end_head %}
     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>

{% endblock %}

{% block content %}
    <div id="content" role="main">
        <h1 class="heading-xlarge">Find areas</h1>
        <div class="grid-row">
            <div class="column-half">
               <div class="form-group">
                   <form method="POST" action="{{ url_for('frontend.geoquery') }}">
                       <fieldset>
                           <legend>
                                <h2 class="heading-medium">
                                   Search for areas by lat/long
                                </h2>
                           </legend>
                           <span class="form-hint">
                               For example enter 54.29159, -1.99674 below
                               <br>
                               (which happens to be Aysgarth in Yorkshire Dales National Park and Richmondshire District Council)
                           </span>
                           {{ form.latitude.label(class="form-label")  }}
                           {{ form.latitude(class="form-control") }}
                           {{ form.longitude.label(class="form-label") }}
                           {{ form.longitude(class="form-control") }}
                       </fieldset>
                       <button style="margin-top: 5px" class="button" type="submit">Go</button>
                       {{ form.csrf_token }}
                    </form>
                </div>
            </div>
            <div class="column-half">
                {% if results %}
                    <h2 class="heading-medium">Results</h2>
                    {% for result in results %}
                        <div class="results">
                            <div id="mapid_{{ loop.index }}" style="width: 400px; height: 300px;"></div>
                            <h3 class="heading-small">Details</h3>
                            <ul class="details">
                                <li>
                                    Area: <a href="{{ url_for('frontend.area', id=result.area.area) }}">{{ result.area.area }}</a>
                                </li>
                                {% if result.organisation %}
                                    <li>
                                        Organisation: <a href="{{ url_for('frontend.organisation', id=result.organisation.organisation) }}">{{ result.organisation.name }}</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                     {% endfor %}
                {% else %}
                    <h2 class="heading-medium">{% if message %}{{ message }}{% endif %}</h2>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block end_body %}
    {% for result in results %}
        <script>
            var map = L.map('mapid_{{ loop.index  }}');

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: '{{ config.MAPBOX_TOKEN }}'
            }).addTo(map);

            {%  if form.latitude.data and form.longitude.data  %}
                L.marker([{{ form.latitude.data }}, {{ form.longitude.data }}]).addTo(map);
            {% endif %}

            geojsonLayer = L.geoJSON({{ result.area.data | tojson }}).addTo(map);
            map.fitBounds(geojsonLayer.getBounds());

        </script>
    {% endfor %}
{% endblock %}
