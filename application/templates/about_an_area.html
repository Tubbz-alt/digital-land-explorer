{% extends "base.html" %}
{% block title %}About an area{% endblock %}

{% block content %}

    <main id="content" role="main">
      <h1 class="heading-xlarge">About an area</h1>
      <form method="GET" action="{{ url_for('frontend.about_an_area') }}" class="form location-search-form">
        <div class="form-group">
          {{ form.query.label(class="form-label")  }}
          {% if query %}
          {{ form.query(class="form-control location", value=query) }}
          {% else %}
          {{ form.query(class="form-control location") }}
          {% endif %}
        </div>
        <div class="form-group">
          <button class="button" type="submit">Search</button>
        </div>
        {{ form.csrf_token }}
      </form>

        {% if results %}
            <div class="grid-row">
                <div class="column-full">
                    <header>
                        {%  set res = results | count %}
                        <h2 class="heading-medium">{{ res }} Result{% if res > 1 %}s{% endif %} for 
                          {% if query %}
                          "{{ query }}"
                          {% else %}
                          {{ latitude }}, {{ longitude }}
                          {% endif %}
                        </h2>
                    </header>
                </div>
            </div>
        {% endif %}

        {% for result in results %}
            <div class="grid-row results">
                <div class="column-two-thirds">
                    <div id="mapid_{{ loop.index }}" style="height: 350px;"></div>
                </div>
                <div class="column-one-third">
                    <h3 class="heading-small">Details</h3>
                    <ul class="details">
                        <li>
                            Area: <a href="{{ url_for('frontend.area', id=result.area.area) }}">
                            {% if result.area.name %}{{ result.area.name }}{% else %}{{ result.area.area }}{% endif %}
                        </a>
                        </li>
                        {% if result.publication %}
                            <li>
                                Publication: <a
                                    href="{{ url_for('frontend.publication', id=result.publication.publication) }}">{{ result.publication.name }}</a>
                            </li>
                        {% endif %}
                        {% if result.organisation %}
                            <li>
                                Organisation: <a
                                    href="{{ url_for('frontend.organisation', id=result.organisation.organisation) }}">{{ result.organisation.name }}</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        {% endfor %}
    </main>

{% endblock %}

{% block end_body %}

    {% for result in results %}
        <script>

            var map = L.map('mapid_{{ loop.index  }}', {zoomControl: false});

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: '{{ config.MAPBOX_TOKEN }}'
            }).addTo(map);

            {%  if latitude and longitude %}
                L.marker([{{ latitude }}, {{ longitude}}]).addTo(map);
            {% endif %}

            geojsonLayer = L.geoJSON({{ result.area.data | tojson }}).addTo(map);
            map.fitBounds(geojsonLayer.getBounds());

        </script>
    {% endfor %}

{% endblock %}
