{% extends "base.html" %}
{% block title %}About an area{% endblock %}

{% block content %}

    <main id="content" role="main">
      <h1 class="heading-xlarge">Search for data about an area</h1>
      <form method="GET" action="{{ url_for('frontend.about_an_area') }}" class="form location-search-form">
        <fieldset class="form-group">
          <legend>
            <h2 class="heading-medium visuallyhidden">
              Search for areas by lat/long
            </h2>
          </legend>
          {{ form.query.label(class="form-label")  }}
          <span class="form-hint text">E.g. "Brockwell Park" or click on map below</span>
          <div class="grid-row">
            <div class="search-form-control-wrapper column-half">
              {% if query %}
              {{ form.query(class="form-control location", value=query) }}
              {% else %}
              {{ form.query(class="form-control location") }}
              {% endif %}
              <button class="button button-search" type="submit">Search</button>
            </div>
          </div>
        </fieldset>
        {{ form.csrf_token }}
      </form>
      <div class="grid-row">
        <div class="column-full">
          <div class="map-wrapper">
						<div id="location-search-map" style="height: 450px;"></div>
						<div class="lat-lng-panel">
							<dl class="definition-inline">
								<dt class="query-meta">Query</dt>
								<dd class="display-query query-meta">{% if query %}{{ query }}{% else %}Lat/Long search{% endif %}</dd>
								<dt>Latitude</dt>
								<dd class="display-lat">{{ '%0.5f'| format(latitude|float) }}</dd>
								<dt>Longitude</dt>
								<dd class="display-lng">{{ '%0.5f'| format(longitude|float) }}</dd>
							</dl>
              {% if query %}
              <a class="button reload-results-btn visually-hidden" href="{{ url_for('frontend.about_an_area') }}?query={{ query }}">Reload results</a>
              {% elif latitude %}
              <a class="button reload-results-btn visually-hidden" href="{{ url_for('frontend.about_an_area') }}?latitude={{ latitude }}&longitude={{ longitude }}">Reload results</a>
              {% else %}
              <a class="button reload-results-btn visually-hidden" href="{{ url_for('frontend.about_an_area') }}">Reload results</a>
              {% endif %}
              
						</div>
					</div>
				</div>
      </div>

        {% if results %}
            <div class="grid-row">
                <div class="column-full">
                    <header>
                        {%  set res = results | count %}
                        <h2 class="heading-medium">{{ res }} Result{% if res > 1 %}s{% endif %} for 
                          {% if query %}
                          "{{ query }}"
                          {% else %}
                          {{ '%0.5f'| format(latitude|float) }}, {{ '%0.5f'| format(longitude|float) }}
                          {% endif %}
                        </h2>
                    </header>
                </div>
            </div>
        {% endif %}

        
          <ul class="results">
        {% for result in results %}
            <li class="result">
              <div class="grid-row">
                <div class="column-two-thirds">
                    <div id="mapid_{{ loop.index }}" style="height: 350px;"></div>
                </div>
                <div class="column-one-third">
                    <h3 class="heading-small">Details</h3>
                    <ul class="details">
                        <li>
                            Area: <a href="{{ url_for('frontend.area', id=result.area.area) }}">
                            {% if result.area.name %}{{ result.area.name }}{% else %}{{ result.area.area }}{% endif %}
                        </a>
                        </li>
                        {% if result.publication %}
                            <li>
                                Publication: <a
                                    href="{{ url_for('frontend.publication', id=result.publication.publication) }}">{{ result.publication.name }}</a>
                            </li>
                        {% endif %}
                        {% if result.organisation %}
                            <li>
                                Organisation: <a
                                    href="{{ url_for('frontend.organisation', id=result.organisation.organisation) }}">{{ result.organisation.name }}</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
              </div>
            </li>
        {% endfor %}
          </ul>
        
    </main>

{% endblock %}

{% block end_body %}
    <script src="/static/javascripts/vendor/jquery-1.11.0.min.js"></script>
    <script>
      (function($, window) {
        var mymap,
					query_marker,
					$form,
					$latlngPanel,
          base_url = "{{ url_for('frontend.about_an_area') }}";

        /* reduce lat or lng number to desirable 
           number of decimal places */
			  var roundLatLngVal = function(latlng, decs) {
				  return parseFloat(latlng.toFixed(decs));
			  };

    		var resetField = function($form, fieldselector) {
          if( $form !== undefined ) {
            $form.find(fieldselector).val("");
          }
        };

        var updateLinkURL = function(linkselector, baseURL, queryStr) {
          var url_str = baseURL + queryStr;
          $( linkselector ).attr("href", url_str).removeClass("visually-hidden");
        };

        /* Given map
  			   create marker at lat and lng
  			   return marker ref */
  			var addMarkerToMap = function(map, lat, lng) {
  				var marker = L.marker([lat, lng]);
  				map.addLayer(marker);
  				return marker;
  			};

        var removeMarkerFromMap = function(marker, map) {
          if( marker ) {
            map.removeLayer( marker );
          }
        };

        /* Update a marker position on a map
            marker: an existing marker object
            Lmap: a leaflet map
            lat: new latitude
            lng: new longitude
            pan: [Bool] if you want map to pan to new marker */
        var updateMarkerPos = function(marker, Lmap, lat, lng, pan) {
          removeMarkerFromMap( marker, Lmap );
  				new_marker = addMarkerToMap(Lmap, lat, lng);
          if ( pan ) {
            Lmap.panTo(new L.LatLng(lat, lng));
          }
          return new_marker;
        };


        /* render a basic leaflet map
            takes #id for the map
            and any leaflet options */
        var renderLeafletMap = function(map_element_id, options) {
          var options = options || {};
          var Lmap = L.map(map_element_id, options);
          L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: '{{ config.MAPBOX_TOKEN }}'
          }).addTo(Lmap);
          return Lmap;
        };

        var renderMap = function(lat, lng) {
          mymap = renderLeafletMap('location-search-map').setView([lat, lng], 12);

          mymap.on('click', function(ev){
            resetField($form, ".location");
            var query_str = "?latitude=" + ev.latlng.lat + "&longitude=" + ev.latlng.lng;
            updateLinkURL(".reload-results-btn", base_url, query_str);
            displayLatLng({
              lat: ev.latlng.lat,
              lng: ev.latlng.lng
            });
          });
        };

        var displayLatLng = function(data) {
  				var $query_meta = $latlngPanel.find(".query-meta");
  				if( data.query ) {
  					$latlngPanel.find(".display-query").text( data.query );
  					$query_meta.show();
  				} else {
  					$query_meta.hide();
  				}
  				$latlngPanel.find(".display-lat").text( roundLatLngVal(data.lat, 5) );
  				$latlngPanel.find(".display-lng").text( roundLatLngVal(data.lng, 5) );
          query_marker = updateMarkerPos( query_marker, mymap, data.lat, data.lng, true);
  			};

        var updateSearchQueryCallback = function(data) {
          var query_str = "?query=" + data.query;
          updateLinkURL(".reload-results-btn", base_url, query_str);
          displayLatLng(data);
        }

        $(function() {
          console.log( "{{ message }}" );

  				$form = $(".location-search-form");
  				$latlngPanel = $(".lat-lng-panel");

          $form.on("submit", function(e){
  					$.ajax({
  					  type: "POST",
  					  contentType: "application/json; charset=utf-8",
  					  url: "/geocode",
  					  data: JSON.stringify({ query: $form.find(".location").val() }),
  					  success: updateSearchQueryCallback,
  					  dataType: "json"
  					});
  					e.preventDefault();
  				});

          {% if latitude %}
          renderMap({{ latitude }}, {{ longitude }});
          query_marker = addMarkerToMap(mymap, {{ latitude }}, {{ longitude }})
          {% else %}
  				renderMap(54.29159, -1.99674);
          {% endif %}
  			});

      }).call(this, jQuery, window);
    </script>
    {% for result in results %}
        <script>

            var map = L.map('mapid_{{ loop.index  }}', {zoomControl: false});

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: '{{ config.MAPBOX_TOKEN }}'
            }).addTo(map);

            {%  if latitude and longitude %}
                L.marker([{{ latitude }}, {{ longitude}}]).addTo(map);
            {% endif %}

            geojsonLayer = L.geoJSON({{ result.area.data | tojson }}).addTo(map);
            map.fitBounds(geojsonLayer.getBounds());

        </script>
    {% endfor %}

{% endblock %}
