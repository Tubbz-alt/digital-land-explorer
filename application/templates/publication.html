{% extends "base.html" %}
{% block title %}{{ publication.publication }}{% endblock %}
{% block end_head %}
    <script src="https://unpkg.com/Leaflet.Deflate@0.3.0/dist/L.Deflate.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>

{% endblock %}
{% block content %}
    <main id="content" role="main">
      {% from "macros/breadcrumbs.html" import render_breadcrumbs %}
      {{ render_breadcrumbs(publication.name, "publications") }}

      <div class="meta-data-panel">
        <div class="grid-row">
          <div class="column-full">
            <h1 class="heading-xlarge">
              <span class="heading-secondary">Publication</span>
              {{ publication.name }}
            </h1>
            <h3 class="heading-medium">
              Published by:
            {% if publication.organisation %}
              <a href="{{ url_for('frontend.organisation', id=publication.organisation.organisation) }}">
                {{ publication.organisation.name }}</a>
            {% endif %}
            </h3>

          </div>
        </div>
        <div class="grid-row mdp-info-section">
          <div class="column-three-quarters">
            <dl class="definition-inline definition-list-spread">
              <dt>Licence</dt>
              <dd><a href="{{ url_for('frontend.licence', id=publication.licence.licence) }}">{{ publication.licence.name }}</a></dd>
              <dt>Attribution</dt>
              <dd><a href="{{ url_for('frontend.attribution', id=publication.copyright.copyright) }}">{{ publication.copyright.name }}</a></dd>
              <dt>Category</dt>
              <dd></dd>
            </dl>
          </div>
          <div class="column-one-quarter mdp-links-section">
            <h4 class="heading-small mdp-heading">Links</h4>
            <ol>
              <li><a href="{{ publication.url }}">Publication</a></li>
              <li><a href="{{ publication.data_url }}">Data</a></li>
            </ol>
          </div>
        </div>
      </div>

      <!--<div class="grid-row">
        <div class="column-one-third">
          <div class="contents-section">
            Contents
            <ol>
              <li>- <a href="#pub-info-description">Description</a></li>
              <li>- <a href="#pub-info-data">Data</a></li>
              <li>- <a href="pub-info-tasks">Tasks performed</a></li>
            </ol>
          </div>
        </div>
        <div class="column-two-thirds"></div>
      </div>-->

      {% macro render_pub_info_section(sectionTitle, sectionId, colWidth="column-two-thirds") %}
      <section class="grid-row pub-info-section" id="{{ sectionId }}">
        <div class="{{ colWidth }}">
          <h3 class="heading-medium pub-info-section__heading">{{ sectionTitle }}</h3>
          {% if caller %}
            {{ caller() }}
          {% endif %}
        </div>
      </section>
      {% endmacro %}

      {% call render_pub_info_section("Description", "pub-info-description") %}
      <p class="text">Description from the markdown file should appear here...</p>
      {% endcall %}

      {% call render_pub_info_section("Data", "pub-info-data", "column-full") %}

      {% if features.features %}
      {% from "macros/data.html" import render_data_component %}
      {{ render_data_component(features.features|length, "Features") }}

      <dl class="definition-inline">
        <dt>Contains feature types</dt>
        <dd>{{ features.features|map(attribute='geometry')|map(attribute='type')|list|unique|join(", ") }}</dd>
      </dl>
      
        <div class="grid-row">
            <div class="column-two-thirds">
                <h2 class="heading-small">{{ publication.name }}</h2>
                <div id="map" style="width: 600px; height: 400px;"></div>
            </div>
            <div class="column-one-third">
                <table class="properties">
                    <caption class="heading-small">Feature properties</caption>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
      {% endif %}
    
      {% endcall %}

      {{ render_pub_info_section("Tasks performed", "pub-info-tasks") }}

    </main>
{% endblock %}


{% block end_body %}
    {% if features.features %}
        <script>

            var polygons = {{ features | tojson }};

            var map = L.map('map', {zoomControl: false});

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox.streets',
                accessToken: '{{ config.MAPBOX_TOKEN }}'
              }
            ).addTo(map);

            L.Polygon.addInitHook(function () {
                this._latlng = this._bounds.getCenter();
            });

            L.Polygon.include({
                getLatLng: function () {
                    return this._latlng;
                },
                setLatLng: function () {
                } // no-op.
            });

            var defaultStyle = {
              color: "#2B8CC4"
            };
            var highlightStyle = {
              color: "#912B88"
            };

            var onEachFeature = function(feature, layer) {
                if(feature.properties.feature){
                    layer.bindTooltip(feature.properties.feature, {sticky: true});
                } else {
                   layer.bindTooltip(feature.properties.item, {sticky: true});
                }
                layer.on('mouseover', function(e) {
                    $('.properties tbody').empty();
                    $.each(feature.properties, function(key, value) {
                        $('.properties tbody').append('<tr><td>' + key +'</td><td>' + value +'</td></tr>');
                    });
                    layer.setStyle(highlightStyle);
                });
                layer.on('mouseout', function(e) {
                  layer.setStyle(defaultStyle);
                });
            };
            

            var markers = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
            var geoJsonLayer = L.geoJson(polygons, {
                onEachFeature : onEachFeature,
                style: defaultStyle
            });

            markers.addLayer(geoJsonLayer);
            map.fitBounds(markers.getBounds());

        </script>
    {% endif %}
{% endblock %}

