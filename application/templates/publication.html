{% extends "base.html" %}
{% block title %}{{ publication.publication }}{% endblock %}
{% block end_head %}
    <script src="https://unpkg.com/Leaflet.Deflate@0.3.0/dist/L.Deflate.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>

{% endblock %}
{% block content %}
    <main id="content" role="main">
      {% from "macros/breadcrumbs.html" import render_breadcrumbs %}
      {{ render_breadcrumbs(publication.name, "publications") }}

      <div class="meta-data-panel">
        <div class="grid-row">
          <div class="column-full">
            <h1 class="heading-xlarge">
              <span class="heading-secondary">Publication</span>
              {{ publication.name }}
            </h1>
            <h3 class="heading-medium">
              Published by:
            {% if publication.organisation %}
              <a href="{{ url_for('frontend.organisation', id=publication.organisation.organisation) }}">
                {{ publication.organisation.name }}</a>
            {% endif %}
            </h3>

          </div>
        </div>
        <div class="grid-row mdp-info-section">
          <div class="column-three-quarters">
            <dl class="definition-inline definition-list-spread">
              <dt>Licence</dt>
              <dd><a href="{{ url_for('frontend.licence', id=publication.licence.licence) }}">{{ publication.licence.name }}</a></dd>
              <dt>Attribution</dt>
              <dd><a href="{{ url_for('frontend.attribution', id=publication.copyright.copyright) }}">{{ publication.copyright.name }}</a></dd>
              <dt>Category</dt>
              <dd></dd>
            </dl>
          </div>
          <div class="column-one-quarter mdp-links-section">
            <h4 class="heading-small mdp-heading">Links</h4>
            <ol>
              <li><a href="{{ publication.url }}">Publication</a></li>
              <li><a href="{{ publication.data_url }}">Data</a></li>
            </ol>
          </div>
        </div>
      </div>

      <div class="grid-row">
        <div class="column-one-third">
          <div class="contents-section">
            Contents
            <ol>
              <li>- <a href="#pub-info-description">Description</a></li>
              <li>- <a href="#pub-info-data">Data</a></li>
              <li>- <a href="pub-info-tasks">Tasks performed</a></li>
            </ol>
          </div>
        </div>
        <div class="column-two-thirds">

          {% macro render_pub_info_section(sectionTitle, sectionId) %}
          <section class="pub-info-section" id="{{ sectionId }}">
            <h3 class="heading-medium pub-info-section__heading">{{ sectionTitle }}</h3>
          </section>
          {% endmacro %}
          {{ render_pub_info_section("Description", "pub-info-description") }}
          {{ render_pub_info_section("Data", "pub-info-data") }}
          {{ render_pub_info_section("Tasks performed", "pub-info-tasks") }}

        </div>
      </div>

      {% if features.features %}
        <div class="grid-row">
            <div class="column-full">
                <h2 class="heading-small">{{ publication.name }}</h2>
                <div id="map" style="width: 900px; height: 600px;"></div>
            </div>
        </div>
      {% endif %}

    </main>
{% endblock %}


{% block end_body %}
    {% if features.features %}
        <script>

            var polygons = {{ features | tojson }};

            var map = L.map('map', {zoomControl: false});

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                id: 'mapbox.streets',
                accessToken: '{{ config.MAPBOX_TOKEN }}'
              }
            ).addTo(map);

            L.Polygon.addInitHook(function () {
                this._latlng = this._bounds.getCenter();
            });

            L.Polygon.include({
                getLatLng: function () {
                    return this._latlng;
                },
                setLatLng: function () {
                } // no-op.
            });

            var onEachFeature = function(feature, layer) {
                layer.bindTooltip(JSON.stringify(feature.properties), {sticky: true});
            };

            var markers = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
            var geoJsonLayer = L.geoJson(polygons, {
                onEachFeature : onEachFeature
            });

            markers.addLayer(geoJsonLayer);
            map.fitBounds(markers.getBounds());

        </script>
    {% endif %}
{% endblock %}

