{% extends "base.html" %}
{% block title %}{{ organisation.organisation }}{% endblock %}

{% block end_head %}
   <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.3.0/dist/MarkerCluster.css" />

    <script src="https://unpkg.com/leaflet.markercluster@1.3.0/dist/leaflet.markercluster.js"></script>
{% endblock %}

{% block content %}
    <div id="content" role="main">

        <div class="grid-row">
            <h1 class="heading-xlarge">{{ organisation.organisation }}</h1>
            <h2 class="heading-medium">{{ organisation.name }}</h2>
        </div>

        {% if organisation.area %}
            <div class="grid-row">
                <div class="column-half">
                    <h2 class="heading-small">Local authority boundary</h2>
                    <div id="mapid" style="width: 400px; height: 300px;"></div>
                    <!-- TODO map here-->
                </div>
                <div class="column-half">
                <h2 class="heading-small">Publications</h2>
                <ul>
                    {% for publication in organisation.publications %}
                    <li>
                        <a href="{{ url_for('frontend.publication', id=publication.publication) }}">
                            {{ publication.name }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            </div>
        {% endif %}

        {% if points %}
            <div class="grid-row">
                <div class="column-full">
                    <h2 class="heading-medium">Lambeth contaminated sites</h2>
                    <div id="map_points" style="width: 900px; height: 600px;"></div>
                </div>
            </div>
        {% endif %}


        <div class="grid-row">
            <div class="column-full">
                {% for key in areas_by_type.keys() %}
                     <h3 class="heading-small">{{ key }}</h3>
                     <div id="map_{{ key }}" style="width: 900px; height: 600px;"></div>
                {% endfor %}
            </div>
        </div>

    </div>
{% endblock %}

{% block end_body %}
    <script>
        var map = L.map('mapid');

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: '{{ config.MAPBOX_TOKEN }}'
        }).addTo(map);

        geojsonLayer = L.geoJSON({{ organisation.feature() | tojson }}).addTo(map);
        map.fitBounds(geojsonLayer.getBounds());

        var pointsMap  = L.map('map_points');

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: '{{ config.MAPBOX_TOKEN }}'
        }).addTo(pointsMap);

        var markers = L.markerClusterGroup();
        {% for point in points %}
            markers.addLayer(L.marker(
                [ {{ point.data['geometry']['coordinates'][1] }}, {{ point.data['geometry']['coordinates'][0] }} ]
                ).bindTooltip('{{ point.area }}')
            );
        {% endfor %}

        pointsMap.addLayer(markers);
        geojsonLayer = L.geoJSON({{ organisation.feature() | tojson }}).addTo(pointsMap);
        pointsMap.fitBounds(geojsonLayer.getBounds());


        {% for key, val in areas_by_type.items() %}

            var otherMap  = L.map('map_{{ key }}');

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: '{{ config.MAPBOX_TOKEN }}'
            }).addTo(otherMap);

            geojsonLayer = L.geoJSON({{ val | tojson }}).addTo(otherMap);
            otherMap.fitBounds(geojsonLayer.getBounds());

        {%  endfor %}

    </script>
{% endblock %}

