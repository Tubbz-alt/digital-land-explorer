{% extends "base.html" %}
{% block title %}Digital Land Explorer{% endblock %}

{% block end_head %}
     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>

    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>

{% endblock %}

{% block content %}

    <header class="hero">
		<div class="hero_content">
			<h1 class="heading-xlarge">Digital Land Explorer</h1>
			<p class="lede text">
				Some organisations, publications and data sets related to land
			</p>
		</div>
	</header>

    <main id="content" role="main">

        <div class="grid-row row">

            <div class="column-one-third">
                <span class="data-item font-medium areas">Areas</span>
                <ul class="list-bullet">
                    <li><a href="{{ url_for('frontend.find_area') }}">Find areas</a></li>
                </ul>
            </div>

             <div class="column-one-third">
               <span class="data-item font-medium">
                     <a href="{{ url_for('frontend.organisations') }}">Organisations</a></span>
                 </span>
            </div>

            <div class="column-one-third">
                <span class="data-item font-medium">
                    <a href="{{ url_for('frontend.publications') }}">Publications</a>
                </span>
            </div>

        </div>

				<div class="grid-row">
					<div class="column-full">
						<h2 class="heading-medium">Search a location</h2>
						<p class="text">Enter a UK address or click on a point on the map below to find out what land data is available. Land data is data such as:</p>
						<ul class="list-bullet">
							<li>Example 1</li>
							<li>Example 2</li>
							<li>Example 3</li>
						</ul>

						<form action="" class="form location-search-form">
							<div class="form-group">
                {{ form.location.label(class="form-label")  }}
                {{ form.location(class="form-control location") }}
							</div>
							<div class="form-group">
              	<button class="button" type="submit">Search</button>
							</div>
              {{ form.csrf_token }}
						</form>
					</div>
					<div class="column-full">
						<div class="map-wrapper">
							<div id="location-search-map" style="height: 450px;"></div>
							<div class="lat-lng-panel">
								<dl class="definition-inline">
									<dt class="query-meta">Query</dt>
									<dd class="display-query query-meta"></dd>
									<dt>Latitude</dt>
									<dd class="display-lat"></dd>
									<dt>Longitude</dt>
									<dd class="display-lng"></dd>
								</dl>
							</div>
						</div>
					</div>
				</div>
    </main>
{% endblock %}

{% block end_body %}
	<script src="/static/javascripts/vendor/jquery-1.11.0.min.js"></script>
	<script>
		(function($, window) {
			var mymap,
					query_marker,
					$form,
					$latlngPanel;

			/* reduce lat or lng number to desirable 
			   number of decimal places */
			var roundLatLngVal = function(latlng, decs) {
				return parseFloat(latlng.toFixed(decs));
			}

			var resetField = function($form, fieldselector) {
				if( $form !== undefined ) {
					$form.find(fieldselector).val("");
				}
			}

			/* Given map
			   create marker at lat and lng
			   return marker ref */
			var addMarkerToMap = function(map, lat, lng) {
				var marker = L.marker([lat, lng]);
				map.addLayer(marker);
				return marker;
			}

			var removeMarkerFromMap = function(marker, map) {
				if( marker ) {
					map.removeLayer( marker );
				}
			}

			var renderMap = function(){
				mymap = L.map('location-search-map').setView([54.29159, -1.99674], 10);

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={{ config.MAPBOX_TOKEN }}', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: '{{ config.MAPBOX_TOKEN }}'
        }).addTo(mymap);

				//query_marker = addMarkerToMap(mymap, place.lat, place.lng);

				mymap.on('click', function(ev){
					resetField($form, ".location");
					displayLatLng({
						lat: ev.latlng.lat,
						lng: ev.latlng.lng
					});
				});
			};

			var displayLatLng = function(data) {
				removeMarkerFromMap( query_marker, mymap );
				var $query_meta = $latlngPanel.find(".query-meta");
				if( data.query ) {
					$latlngPanel.find(".display-query").text( data.query );
					$query_meta.show();
				} else {
					$query_meta.hide();
				}
				$latlngPanel.find(".display-lat").text( roundLatLngVal(data.lat, 5) );
				$latlngPanel.find(".display-lng").text( roundLatLngVal(data.lng, 5) );
				query_marker = addMarkerToMap(mymap, data.lat, data.lng);
				mymap.panTo(new L.LatLng(data.lat, data.lng));
			};

			$(function() {
				$form = $(".location-search-form");
				$latlngPanel = $(".lat-lng-panel");

				$form.on("submit", function(e){
					$.ajax({
					  type: "POST",
					  contentType: "application/json; charset=utf-8",
					  url: "/geocode",
					  data: JSON.stringify({ query: $form.find(".location").val() }),
					  success: displayLatLng,
					  dataType: "json"
					});
					e.preventDefault();
				});

				renderMap();
			});
		}).call(this, jQuery, window);
	</script>
{% endblock %}

